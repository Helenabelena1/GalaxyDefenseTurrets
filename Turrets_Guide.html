<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Turret Card Reference</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap');

  :root {
    --bg-primary: #0a0e1a;
    --bg-secondary: #111827;
    --bg-card: #1a2035;
    --bg-card-hover: #1f2847;
    --border-primary: #1e293b;
    --border-glow: rgba(99,102,241,0.3);
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent-blue: #6366f1;
    --accent-purple: #a855f7;
    --accent-gold: #fbbf24;
    --accent-cyan: #22d3ee;
    --accent-red: #ef4444;
    --accent-orange: #f97316;
    --accent-green: #10b981;
    --accent-pink: #ec4899;
    --tier1-color: #6366f1;
    --tier2-color: #a855f7;
    --tier3-color: #fbbf24;
    --chain-color: #22d3ee;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background:
      radial-gradient(ellipse at 20% 0%, rgba(99,102,241,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(168,85,247,0.06) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }

  /* === HEADER === */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,14,26,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-primary);
    padding: 0 2rem;
  }
  .header-inner {
    max-width: 1400px; margin: 0 auto;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo-text {
    font-size: 1.1rem; font-weight: 700;
    background: linear-gradient(135deg, #e2e8f0, #94a3b8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .search-wrap { position: relative; width: 320px; }
  .search-wrap svg {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    color: var(--text-muted); width: 16px; height: 16px;
  }
  .search-input {
    width: 100%; padding: 9px 14px 9px 40px;
    background: var(--bg-secondary); border: 1px solid var(--border-primary);
    border-radius: 10px; color: var(--text-primary); font-size: 0.875rem;
    font-family: inherit; outline: none; transition: all 0.2s;
  }
  .search-input:focus {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
  }
  .search-input::placeholder { color: var(--text-muted); }

  /* === FILTER BAR === */
  .filter-bar {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-primary);
    padding: 10px 2rem;
  }
  .filter-bar-inner {
    max-width: 1400px; margin: 0 auto;
    display: flex; flex-direction: column; gap: 8px;
  }
  .filter-row {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .filter-label {
    font-size: 0.65rem; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.06em;
    min-width: 80px; flex-shrink: 0;
  }
  .filter-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 11px; border-radius: 20px; font-size: 0.7rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s; border: 1.5px solid transparent;
    user-select: none;
  }
  .filter-badge:hover { transform: translateY(-1px); }
  .filter-badge.active { border-color: currentColor; }
  .filter-badge .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

  /* Card type filters */
  .ft-normal { background: rgba(148,163,184,0.1); color: #94a3b8; }
  .ft-normal .dot { background: #94a3b8; }
  .ft-chain { background: rgba(34,211,238,0.1); color: #22d3ee; }
  .ft-chain .dot { background: #22d3ee; }
  .ft-combo { background: rgba(16,185,129,0.1); color: #10b981; }
  .ft-combo .dot { background: #10b981; }
  .ft-breakthrough { background: rgba(251,191,36,0.1); color: #fbbf24; }
  .ft-breakthrough .dot { background: #fbbf24; }

  /* Effect filters */
  .fe-paralyze { background: rgba(251,191,36,0.1); color: #fbbf24; }
  .fe-paralyze .dot { background: #fbbf24; }
  .fe-disruption { background: rgba(168,85,247,0.1); color: #a855f7; }
  .fe-disruption .dot { background: #a855f7; }
  .fe-burn { background: rgba(249,115,22,0.1); color: #f97316; }
  .fe-burn .dot { background: #f97316; }
  .fe-vulnerable { background: rgba(239,68,68,0.1); color: #ef4444; }
  .fe-vulnerable .dot { background: #ef4444; }
  .fe-slow { background: rgba(34,211,238,0.1); color: #22d3ee; }
  .fe-slow .dot { background: #22d3ee; }
  .fe-physvuln { background: rgba(236,72,153,0.1); color: #ec4899; }
  .fe-physvuln .dot { background: #ec4899; }

  /* Tier filters */
  .ftier-1 { background: rgba(99,102,241,0.1); color: var(--tier1-color); }
  .ftier-1 .dot { background: var(--tier1-color); }
  .ftier-2 { background: rgba(168,85,247,0.1); color: var(--tier2-color); }
  .ftier-2 .dot { background: var(--tier2-color); }
  .ftier-3 { background: rgba(251,191,36,0.1); color: var(--tier3-color); }
  .ftier-3 .dot { background: var(--tier3-color); }

  .filter-clear {
    padding: 4px 11px; border-radius: 20px; font-size: 0.7rem; font-weight: 600;
    cursor: pointer; background: rgba(148,163,184,0.08); color: var(--text-muted);
    border: none; font-family: inherit; transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 4px;
  }
  .filter-clear.has-filters { background: rgba(239,68,68,0.12); color: #ef4444; }
  .filter-clear:hover { background: rgba(239,68,68,0.2); color: #ef4444; }

  /* === STATS BAR === */
  .stats-bar {
    max-width: 1400px; margin: 16px auto 0; padding: 0 2rem;
    display: flex; align-items: center; gap: 16px;
  }
  .stat-chip {
    padding: 4px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;
    background: rgba(255,255,255,0.04); color: var(--text-secondary);
  }
  .stat-chip strong { color: var(--text-primary); }

  /* === MAIN LAYOUT === */
  .main { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem 2rem; position: relative; z-index: 1; }

  /* === TURRET GRID === */
  .turret-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px; margin-bottom: 2rem;
  }
  .turret-tile {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 14px;
    padding: 20px 16px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
    position: relative; overflow: hidden; text-align: center;
  }
  .turret-tile::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: var(--tile-accent, var(--accent-blue));
    opacity: 0; transition: opacity 0.25s;
  }
  .turret-tile:hover, .turret-tile.active {
    background: var(--bg-card-hover);
    border-color: var(--tile-accent, var(--accent-blue));
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.3), 0 0 20px color-mix(in srgb, var(--tile-accent, var(--accent-blue)) 15%, transparent);
  }
  .turret-tile:hover::before, .turret-tile.active::before { opacity: 1; }
  .turret-tile.active { border-width: 2px; }
  .turret-tile.hidden { display: none; }
  .tile-icon {
    width: 52px; height: 52px; border-radius: 14px; margin: 0 auto 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
  }
  .tile-name { font-size: 0.875rem; font-weight: 700; letter-spacing: 0.02em; margin-bottom: 4px; }
  .tile-type { font-size: 0.7rem; color: var(--text-muted); font-weight: 500; }
  .tile-card-count {
    display: inline-flex; align-items: center; gap: 4px;
    margin-top: 10px; padding: 3px 10px;
    background: rgba(255,255,255,0.04); border-radius: 20px;
    font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;
  }

  /* === DETAIL PANEL === */
  .detail-panel {
    display: none;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 18px; overflow: hidden;
    animation: slideDown 0.35s cubic-bezier(0.4,0,0.2,1);
    margin-bottom: 2rem;
  }
  .detail-panel.open { display: block; }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .detail-header {
    padding: 28px 32px 20px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border-primary);
  }
  .detail-header-left { display: flex; align-items: center; gap: 16px; }
  .detail-icon {
    width: 56px; height: 56px; border-radius: 16px;
    display: flex; align-items: center; justify-content: center; font-size: 28px;
  }
  .detail-title { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.01em; }
  .detail-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
  .close-btn {
    width: 36px; height: 36px; border-radius: 10px;
    background: rgba(255,255,255,0.05); border: 1px solid var(--border-primary);
    color: var(--text-muted); cursor: pointer; font-size: 18px;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .close-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

  /* === TABS === */
  .tab-bar {
    display: flex; padding: 0 32px;
    border-bottom: 1px solid var(--border-primary); gap: 4px;
  }
  .tab-btn {
    padding: 14px 20px; font-size: 0.8rem; font-weight: 600;
    font-family: inherit; color: var(--text-muted); background: none; border: none;
    cursor: pointer; position: relative; transition: color 0.2s;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
  }
  .tab-btn:hover { color: var(--text-secondary); }
  .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--accent-blue); }
  .tab-btn .tab-count {
    display: inline-flex; align-items: center; justify-content: center;
    min-width: 20px; height: 20px; padding: 0 6px;
    border-radius: 10px; font-size: 0.65rem; font-weight: 700; margin-left: 6px;
  }
  .tab-btn[data-tier="1"] .tab-count { background: rgba(99,102,241,0.15); color: var(--tier1-color); }
  .tab-btn[data-tier="2"] .tab-count { background: rgba(168,85,247,0.15); color: var(--tier2-color); }
  .tab-btn[data-tier="3"] .tab-count { background: rgba(251,191,36,0.15); color: var(--tier3-color); }
  .tab-btn[data-tier="chains"] .tab-count { background: rgba(34,211,238,0.15); color: var(--chain-color); }

  /* === CARD ROWS === */
  .tab-content { display: none; padding: 24px 32px 32px; }
  .tab-content.active { display: block; }
  .card-list { display: flex; flex-direction: column; gap: 8px; }

  .card-row {
    display: grid;
    grid-template-columns: minmax(180px, 1fr) 2fr auto;
    gap: 12px 16px;
    align-items: center;
    padding: 14px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    transition: all 0.2s;
  }
  .card-row:hover { background: var(--bg-card-hover); border-color: rgba(255,255,255,0.08); }
  .card-row.chain-root { border-left: 3px solid var(--chain-color); }
  .card-row.chain-child { border-left: 3px solid rgba(34,211,238,0.3); margin-left: 16px; }
  .card-row.combo-card { border-left: 3px solid var(--accent-green); }
  .card-row.combo-card.chain-root { border-left: 3px solid var(--chain-color); }
  .card-row.combo-card.chain-child { border-left: 3px solid rgba(34,211,238,0.3); }
  .card-row.highlight-flash {
    animation: flashHighlight 1.5s ease-out;
  }
  @keyframes flashHighlight {
    0% { box-shadow: 0 0 0 3px var(--chain-color), 0 0 20px rgba(34,211,238,0.3); background: rgba(34,211,238,0.08); }
    100% { box-shadow: none; background: var(--bg-card); }
  }
  .card-row.filter-hidden { display: none; }
  .tier-section-empty { display: none; }

  .card-name-cell { display: flex; align-items: center; gap: 10px; }
  .card-name { font-size: 0.875rem; font-weight: 600; }
  .chain-icon {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; border-radius: 6px;
    background: rgba(34,211,238,0.12); color: var(--chain-color);
    font-size: 11px; flex-shrink: 0;
  }
  .card-effect { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.5; }
  .card-meta { display: flex; gap: 5px; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end; }
  .meta-tag {
    padding: 3px 8px; border-radius: 6px;
    font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.04em; white-space: nowrap;
  }
  .tag-chain { background: rgba(34,211,238,0.12); color: var(--chain-color); }
  .tag-combo { background: rgba(16,185,129,0.12); color: var(--accent-green); }
  .tag-unlock { background: rgba(251,191,36,0.12); color: var(--accent-gold); }
  .tag-normal { background: rgba(148,163,184,0.08); color: var(--text-muted); }

  /* === CARD TYPE BADGE (next to name) === */
  .card-type-badge {
    padding: 2px 7px; border-radius: 4px;
    font-size: 0.6rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.03em;
    flex-shrink: 0;
  }
  .ctb-normal { background: rgba(148,163,184,0.08); color: #64748b; }
  .ctb-chain { background: rgba(34,211,238,0.1); color: #22d3ee; }
  .ctb-combo { background: rgba(16,185,129,0.1); color: #10b981; }
  .ctb-breakthrough { background: rgba(251,191,36,0.1); color: #fbbf24; }

  /* === COMBO STRIP === */
  .combo-strip {
    grid-column: 1 / -1;
    display: flex; align-items: center; gap: 8px;
    padding: 7px 12px; margin-top: 4px;
    background: rgba(16,185,129,0.04);
    border: 1px solid rgba(16,185,129,0.12);
    border-radius: 8px;
    flex-wrap: wrap;
  }
  .combo-strip-label {
    font-size: 0.65rem; font-weight: 700; color: var(--accent-green);
    text-transform: uppercase; letter-spacing: 0.06em;
    white-space: nowrap;
  }
  .combo-turret-link {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 6px;
    font-size: 0.75rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    text-decoration: none; white-space: nowrap;
    background: rgba(255,255,255,0.05); color: var(--text-primary);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .combo-turret-link:hover {
    background: rgba(255,255,255,0.1); transform: translateY(-1px);
    border-color: rgba(255,255,255,0.15);
  }
  .combo-turret-link .combo-icon { font-size: 14px; }
  .combo-plus { color: var(--accent-green); font-weight: 700; font-size: 14px; }

  /* === CHAIN PATH STRIP === */
  .chain-path-strip {
    display: flex; align-items: center; gap: 0;
    padding: 7px 12px; margin-top: 4px;
    background: rgba(34,211,238,0.04);
    border: 1px solid rgba(34,211,238,0.1);
    border-radius: 8px;
    flex-wrap: wrap;
    grid-column: 1 / -1;
  }
  .chain-path-strip .cp-label {
    font-size: 0.65rem; font-weight: 700; color: var(--chain-color);
    text-transform: uppercase; letter-spacing: 0.06em;
    margin-right: 10px; white-space: nowrap;
  }
  .chain-path-node {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 6px;
    font-size: 0.75rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    text-decoration: none; white-space: nowrap;
  }
  .chain-path-node:hover { transform: translateY(-1px); filter: brightness(1.3); }
  .chain-path-node.cp-current { outline: 2px solid currentColor; outline-offset: 1px; cursor: default; }
  .chain-path-node.cp-current:hover { transform: none; filter: none; }
  .cp-t1 { background: rgba(99,102,241,0.12); color: var(--tier1-color); }
  .cp-t2 { background: rgba(168,85,247,0.12); color: var(--tier2-color); }
  .cp-t3 { background: rgba(251,191,36,0.12); color: var(--tier3-color); }
  .chain-path-arrow { color: var(--text-muted); font-size: 12px; margin: 0 4px; flex-shrink: 0; }

  /* === STATUS EFFECT PILLS === */
  .fx-pill {
    display: inline-flex; align-items: center; gap: 3px;
    padding: 1px 7px; border-radius: 4px;
    font-size: 0.72rem; font-weight: 700; vertical-align: middle;
    cursor: pointer; position: relative;
    transition: filter 0.15s;
  }
  .fx-pill:hover { filter: brightness(1.25); }
  .fx-pill::after {
    content: '?';
    font-size: 0.6rem; opacity: 0.6;
    margin-left: 1px;
  }
  .fx-paralyze { background: rgba(251,191,36,0.15); color: #fbbf24; }
  .fx-disruption { background: rgba(168,85,247,0.15); color: #c084fc; }
  .fx-burn { background: rgba(249,115,22,0.15); color: #fb923c; }
  .fx-vulnerable { background: rgba(239,68,68,0.15); color: #f87171; }
  .fx-slow { background: rgba(34,211,238,0.15); color: #22d3ee; }
  .fx-physvuln { background: rgba(236,72,153,0.15); color: #f472b6; }

  /* === EFFECT TOOLTIP === */
  .effect-tooltip {
    position: fixed;
    z-index: 9999;
    max-width: 240px;
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 10px;
    padding: 10px 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    pointer-events: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.15s, transform 0.15s;
  }
  .effect-tooltip.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
  .tooltip-name {
    font-size: 0.75rem; font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.05em;
    margin-bottom: 5px;
  }
  .tooltip-desc {
    font-size: 0.78rem; color: var(--text-secondary); line-height: 1.5;
  }
  .tooltip-arrow {
    position: absolute;
    bottom: -6px; left: 50%;
    transform: translateX(-50%);
    width: 10px; height: 6px;
    overflow: hidden;
  }
  .tooltip-arrow::before {
    content: '';
    position: absolute;
    top: -6px; left: 50%;
    transform: translateX(-50%) rotate(45deg);
    width: 10px; height: 10px;
    background: #1e293b;
    border: 1px solid #334155;
  }

  /* === CHAIN TREE === */
  .chain-tree-section { display: flex; flex-direction: column; gap: 28px; }
  .chain-tree {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 14px; padding: 24px;
  }
  .chain-tree-title {
    font-size: 0.8rem; font-weight: 700; color: var(--chain-color);
    text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 8px;
  }
  .chain-tree-title::before {
    content: ''; width: 10px; height: 10px; border-radius: 50%;
    background: var(--chain-color);
  }
  .chain-nodes { display: flex; flex-direction: column; gap: 0; }
  .chain-node {
    display: flex; align-items: center; gap: 14px;
    padding: 12px 16px; position: relative;
    border-radius: 8px; transition: background 0.15s; cursor: pointer;
  }
  .chain-node:hover { background: rgba(255,255,255,0.03); }
  .chain-node::before {
    content: '';
    position: absolute; left: 28px; top: 0; bottom: 0;
    width: 2px; background: rgba(34,211,238,0.15);
  }
  .chain-node:first-child::before { top: 50%; }
  .chain-node:last-child::before { bottom: 50%; }
  .chain-node:only-child::before { display: none; }
  .node-dot {
    width: 16px; height: 16px; border-radius: 50%;
    flex-shrink: 0; z-index: 1;
    display: flex; align-items: center; justify-content: center;
  }
  .node-dot-inner { width: 8px; height: 8px; border-radius: 50%; }
  .node-t1 .node-dot { background: rgba(99,102,241,0.2); }
  .node-t1 .node-dot-inner { background: var(--tier1-color); }
  .node-t2 .node-dot { background: rgba(168,85,247,0.2); }
  .node-t2 .node-dot-inner { background: var(--tier2-color); }
  .node-t3 .node-dot { background: rgba(251,191,36,0.2); }
  .node-t3 .node-dot-inner { background: var(--tier3-color); }
  .node-info { flex: 1; }
  .node-name { font-size: 0.85rem; font-weight: 600; }
  .node-tier {
    font-size: 0.7rem; font-weight: 600;
    padding: 2px 8px; border-radius: 4px;
    display: inline-block; margin-top: 3px;
  }
  .node-t1 .node-tier { background: rgba(99,102,241,0.12); color: var(--tier1-color); }
  .node-t2 .node-tier { background: rgba(168,85,247,0.12); color: var(--tier2-color); }
  .node-t3 .node-tier { background: rgba(251,191,36,0.12); color: var(--tier3-color); }
  .node-effect { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; line-height: 1.35; max-width: 190px; }
  .node-arrow { color: var(--text-muted); font-size: 16px; flex-shrink: 0; margin: 0 4px; }

  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    .header-inner { flex-direction: column; height: auto; padding: 12px 0; gap: 10px; }
    .search-wrap { width: 100%; }
    .turret-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    .card-row { grid-template-columns: 1fr; gap: 8px; }
    .card-meta { justify-content: flex-start; }
    .tab-bar { overflow-x: auto; }
    .detail-header, .tab-bar, .tab-content { padding-left: 20px; padding-right: 20px; }
    .filter-label { min-width: 60px; }
  }
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg-primary); }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #475569; }

</style>
<body>

<!-- Effect tooltip popup -->
<div class="effect-tooltip" id="effectTooltip">
  <div class="tooltip-name" id="tooltipName"></div>
  <div class="tooltip-desc" id="tooltipDesc"></div>
  <div class="tooltip-arrow"></div>
</div>

<div class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üéØ</div>
      <span class="logo-text">Turret Card Reference</span>
    </div>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" class="search-input" id="searchInput" placeholder="Search cards, effects, turrets...">
    </div>
  </div>
</div>

<div class="filter-bar">
  <div class="filter-bar-inner">
    <div class="filter-row">
      <span class="filter-label">Card Type</span>
      <span class="filter-badge ft-normal" data-filter="type" data-value="normal" onclick="toggleFilter(this)"><span class="dot"></span>Normal</span>
      <span class="filter-badge ft-chain" data-filter="type" data-value="chain" onclick="toggleFilter(this)"><span class="dot"></span>Chain</span>
      <span class="filter-badge ft-combo" data-filter="type" data-value="combo" onclick="toggleFilter(this)"><span class="dot"></span>Combo</span>
      <span class="filter-badge ft-breakthrough" data-filter="type" data-value="breakthrough" onclick="toggleFilter(this)"><span class="dot"></span>Breakthrough</span>
    </div>
    <div class="filter-row">
      <span class="filter-label">Effect</span>
      <span class="filter-badge fe-paralyze" data-filter="effect" data-value="Paralyze" onclick="toggleFilter(this)"><span class="dot"></span>Paralyze</span>
      <span class="filter-badge fe-disruption" data-filter="effect" data-value="Disruption" onclick="toggleFilter(this)"><span class="dot"></span>Disruption</span>
      <span class="filter-badge fe-burn" data-filter="effect" data-value="Burn" onclick="toggleFilter(this)"><span class="dot"></span>Burn</span>
      <span class="filter-badge fe-vulnerable" data-filter="effect" data-value="Vulnerable" onclick="toggleFilter(this)"><span class="dot"></span>Vulnerable</span>
      <span class="filter-badge fe-slow" data-filter="effect" data-value="Slow" onclick="toggleFilter(this)"><span class="dot"></span>Slow</span>
      <span class="filter-badge fe-physvuln" data-filter="effect" data-value="Physical Vulnerable" onclick="toggleFilter(this)"><span class="dot"></span>Phys Vuln</span>
    </div>
    <div class="filter-row">
      <span class="filter-label">Tier</span>
      <span class="filter-badge ftier-1" data-filter="tier" data-value="1" onclick="toggleFilter(this)"><span class="dot"></span>Tier 1</span>
      <span class="filter-badge ftier-2" data-filter="tier" data-value="2" onclick="toggleFilter(this)"><span class="dot"></span>Tier 2</span>
      <span class="filter-badge ftier-3" data-filter="tier" data-value="3" onclick="toggleFilter(this)"><span class="dot"></span>Tier 3</span>
      <button class="filter-clear" id="clearFilters" onclick="clearAllFilters()">‚úï Reset All Filters</button>
    </div>
  </div>
</div>

<div class="stats-bar" id="statsBar"></div>

<div class="main">
  <div class="turret-grid" id="turretGrid"></div>
  <div class="detail-panel" id="detailPanel"></div>
</div>


<script>
// ============================================================
// COMBO LOOKUP
// ============================================================
const COMBOS = {
  "Piercing Blast": [
    "Aeroblast",
    "Railgun"
  ],
  "Firewheel Summon": [
    "Aeroblast",
    "Firewheel Drone"
  ],
  "Gravity Bomb": [
    "Aeroblast",
    "Gravity Vortex Gun"
  ],
  "Shatter Impact": [
    "Aeroblast",
    "Laser"
  ],
  "Target Explosion": [
    "Beam",
    "Skyguard"
  ],
  "Disruptive Beam": [
    "Beam",
    "Disruption Drone"
  ],
  "Beam Lightning": [
    "Beam",
    "Thunderbolt"
  ],
  "Matrix Resonance": [
    "Beam",
    "Teslacoil"
  ],
  "Small Laser": [
    "Disruption Drone",
    "Laser"
  ],
  "Electric Field": [
    "Disruption Drone",
    "Teslacoil"
  ],
  "Fortress Support": [
    "Disruption Drone",
    "Guardian"
  ],
  "Field Replication": [
    "Disruption Drone",
    "Railgun"
  ],
  "Firewheel Ignition": [
    "Firewheel Drone",
    "Laser"
  ],
  "Vortex Firewheel": [
    "Firewheel Drone",
    "Gravity Vortex Gun"
  ],
  "Extra Barrage": [
    "Firewheel Drone",
    "Railgun"
  ],
  "Blazing Pulse": [
    "Firewheel Drone",
    "Wasp (Hive)"
  ],
  "Flame Bullet": [
    "Guardian",
    "Laser"
  ],
  "Electric Bullet": [
    "Guardian",
    "Thunderbolt"
  ],
  "Counterwave Scatter": [
    "Guardian",
    "Railgun"
  ],
  "Laser Shot": [
    "Guardian",
    "Laser"
  ],
  "Disruption Fire": [
    "Guardian",
    "Disruption Drone"
  ],
  "Mirror Guardian": [
    "Guardian",
    "Wasp (Hive)"
  ],
  "Energy Paralysis": [
    "Laser",
    "Thunderbolt"
  ],
  "Graviton Laser": [
    "Laser",
    "Gravity Vortex Gun"
  ],
  "Convergence Trigger": [
    "Laser",
    "Beam"
  ],
  "Energy Detonation": [
    "Laser",
    "Skyguard"
  ],
  "Field Reflection": [
    "Gravity Vortex Gun",
    "Skyguard"
  ],
  "Field Disruption": [
    "Gravity Vortex Gun",
    "Disruption Drone"
  ],
  "Double Fission": [
    "Gravity Vortex Gun",
    "Railgun"
  ],
  "Binary Stars": [
    "Gravity Vortex Gun",
    "Teslacoil"
  ],
  "Piercing Mark": [
    "Railgun",
    "Guardian"
  ],
  "Surge Pierce": [
    "Railgun",
    "Teslacoil"
  ],
  "Secondary Minefield": [
    "Railgun",
    "Aeroblast"
  ],
  "Piercing Ricochet": [
    "Railgun",
    "Laser"
  ],
  "Collapse Explosion": [
    "Skyguard",
    "Gravity Vortex Gun"
  ],
  "Detonation Thunderbolt": [
    "Skyguard",
    "Thunderbolt"
  ],
  "Path Strike": [
    "Skyguard",
    "Railgun"
  ],
  "Cooperative Beam": [
    "Teslacoil",
    "Beam"
  ],
  "Wasp Mirage": [
    "Teslacoil",
    "Wasp (Hive)"
  ],
  "Highvolt Trigger": [
    "Teslacoil",
    "Thunderbolt"
  ],
  "Spinning Laser": [
    "Teslacoil",
    "Laser"
  ],
  "Lightning Trail": [
    "Thunderbolt",
    "Firewheel Drone"
  ],
  "Lightning Teleportation": [
    "Thunderbolt",
    "Disruption Drone"
  ],
  "Electro-Wasps": [
    "Wasp (Hive)",
    "Teslacoil"
  ],
  "Aero Split": [
    "Wasp (Hive)",
    "Railgun"
  ],
  "Volley Wasp": [
    "Wasp (Hive)",
    "Guardian"
  ],
  "Swarm Fury": [
    "Wasp (Hive)",
    "Laser"
  ]
};

// ============================================================
// TURRET DATA
// ============================================================
const TURRETS = [
  {
    name: "Aeroblast", icon: "üí•", type: "Explosive / AoE", accent: "#ef4444",
    tiers: {
      1: { cards: [
        { name: "Powerful Blast", effect: "Shell DMG +50%" },
        { name: "Multiple Blast", effect: "Shell +1, DMG -15%" },
        { name: "Impact Enhancement", effect: "Shell Knockback +50%, DMG +30%" },
        { name: "Shotgun Barrage", effect: "After firing, launches 5 penetrating Shotgun Shells", chain: "root", chainTo: ["Extra Loading (T2)", "Shotgun Penetration (T3)"] },
        { name: "Floating Mine", effect: "Shell leaves 1 floating mine in explosion area", chain: "root", chainTo: ["Wide Minefield (T2)", "Mine Shockwave (T2 Lv14)"] },
        { name: "Massive Explosion", effect: "Shell explosion range +70%" },
        { name: "Central Blast", effect: "Shells deal additional high-energy explosion to center area" },
      ]},
      2: { cards: [
        { name: "Extra Loading", effect: "Per enemy hit, +1 penetrating Shotgun Shell (MAX 10)", chain: "child", chainFrom: "Shotgun Barrage" },
        { name: "Wide Minefield", effect: "Floating Mine +2, explosion DMG +25%", chain: "child", chainFrom: "Floating Mine" },
        { name: "Mine Shockwave", effect: "Floating Mine Knockback +100%", chain: "child", chainFrom: "Floating Mine", unlock: "Lv14" },
        { name: "Chain Explosion", effect: "Per enemy hit by explosion, +20% DMG (MAX 200%)" },
        { name: "Range Extension", effect: "Range +70%" },
        { name: "Secondary Explosion", effect: "Enemies hit trigger additional explosion after 1s", unlock: "Lv18" },
        { name: "Piercing Blast", effect: "Shell Penetration +1" },
        { name: "Firewheel Summon", effect: "Per enemy hit by explosion, generates a small Firewheel Drone" },
      ]},
      3: { cards: [
        { name: "Shotgun Penetration", effect: "Penetrating Shotgun Shells: Penetration DMG +50%, Range +70%", chain: "child", chainFrom: "Shotgun Barrage" },
        { name: "Gravity Bomb", effect: "Shell DMG +100%, pulls enemies to center before explosion" },
        { name: "Shatter Impact", effect: "Creates two additional Ripping Lasers upon impact", unlock: "Lv22" },
      ]},
    },
    chains: [
      { name: "Shotgun Barrage Path", nodes: [
        { name: "Shotgun Barrage", tier: 1 }, { name: "Extra Loading", tier: 2 }, { name: "Shotgun Penetration", tier: 3 }
      ]},
      { name: "Floating Mine Path", nodes: [
        { name: "Floating Mine", tier: 1 }, { name: "Wide Minefield", tier: 2 }, { name: "Mine Shockwave", tier: 2, note: "Lv14" }
      ]},
    ]
  },
  {
    name: "Beam", icon: "‚ö°", type: "Continuous / Single-target", accent: "#6366f1",
    tiers: {
      1: { cards: [
        { name: "Beam Boost", effect: "DMG +50%" },
        { name: "Efficient Beam", effect: "Cooldown speed +30%" },
        { name: "Damage Increase", effect: "Increasing damage to same target (MAX 200%)", chain: "root", chainTo: ["Stacking Damage (T2)", "Extreme Focus (T3)"] },
        { name: "High-Frequency Beam", effect: "Duration +40%" },
        { name: "Beam Refraction", effect: "Generates refracted beams with +2 refractions on hit", chain: "root", chainTo: ["Refraction Pull (T2)", "Refraction Explosion (T3)"] },
        { name: "DMG Multiplier", effect: "DMG interval -40%" },
        { name: "Beam Penetration", effect: "All Beams inflict [Vulnerable]", fx: "Vulnerable" },
      ]},
      2: { cards: [
        { name: "Stacking Damage", effect: "Damage continues to increase when switching targets", chain: "child", chainFrom: "Damage Increase" },
        { name: "Refraction Pull", effect: "Refraction +2, refracted Beams pull target toward center", chain: "child", chainFrom: "Beam Refraction" },
        { name: "Slaughtering Beam", effect: "Per enemy killed, DMG +10% (MAX 100%)" },
        { name: "Extra Beam", effect: "Release an additional secondary Beam" },
        { name: "Target Explosion", effect: "Each hit triggers an explosion" },
        { name: "Disruptive Beam", effect: "Targets struck create a small disruption field", unlock: "Lv22" },
      ]},
      3: { cards: [
        { name: "Extreme Focus", effect: "Damage stacking cap ‚Üí 400%", chain: "child", chainFrom: "Damage Increase" },
        { name: "Refraction Explosion", effect: "Each hit by refracted Beam causes explosion", chain: "child", chainFrom: "Beam Refraction" },
        { name: "Beam Lightning", effect: "30% chance per hit to trigger 1 Chain Lightning" },
        { name: "Matrix Resonance", effect: "Generates an Electric Matrix on hit", unlock: "Lv14" },
      ]},
    },
    chains: [
      { name: "Damage Increase Path", nodes: [
        { name: "Damage Increase", tier: 1 }, { name: "Stacking Damage", tier: 2 }, { name: "Extreme Focus", tier: 3 }
      ]},
      { name: "Beam Refraction Path", nodes: [
        { name: "Beam Refraction", tier: 1 }, { name: "Refraction Pull", tier: 2 }, { name: "Refraction Explosion", tier: 3 }
      ]},
    ]
  },
  {
    name: "Disruption Drone", icon: "üåÄ", type: "Field / Debuff", accent: "#a855f7",
    tiers: {
      1: { cards: [
        { name: "Field Amplification", effect: "Field DMG +50%" },
        { name: "Field Duration", effect: "Field duration +30%" },
        { name: "Field Expansion", effect: "Field DMG Range +30%" },
        { name: "Disruption Force", effect: "Each tick inflicts 1 stack of [Disruption]", chain: "root", chainTo: ["Disruption Burst (T2)", "Overcharged Field (T2 Lv22)", "Area Disruption (T3)"], fx: "Disruption" },
        { name: "Random Disturbance", effect: "Enemies hit have 5% chance to teleport back", chain: "root", chainTo: ["Rewind Teleport (T2)", "Teleport Damage (T3)"] },
        { name: "Final Blast", effect: "Field causes explosion DMG when it ends" },
        { name: "Stasis Field", effect: "Each tick adds +10% slow (MAX 90%)" },
      ]},
      2: { cards: [
        { name: "Disruption Burst", effect: "At MAX [Disruption] stacks, deals high burst DMG", chain: "child", chainFrom: "Disruption Force", fx: "Disruption" },
        { name: "Rewind Teleport", effect: "2.5% chance to teleport enemy to start point", chain: "child", chainFrom: "Random Disturbance" },
        { name: "Overcharged Field", effect: "[Disruption] DMG +100%, max stacks ‚Üí 5", chain: "child", chainFrom: "Disruption Force", unlock: "Lv22", fx: "Disruption" },
        { name: "Quick Cooldown", effect: "DMG interval -30%, cooldown speed +30%" },
        { name: "Field Suppression", effect: "Enemies in field take increasing additional DMG/s (MAX 200%)" },
        { name: "Small Laser", effect: "Sweeping Laser generated in center of Drone" },
        { name: "Electric Field", effect: "30% chance to inflict [Paralyze]", fx: "Paralyze" },
        { name: "Slaughtering Beam", effect: "Per enemy killed by Beam, Drone DMG +10% (MAX 100%)" },
      ]},
      3: { cards: [
        { name: "Area Disruption", effect: "At MAX [Disruption] stacks, deals 1 extra DMG", chain: "child", chainFrom: "Disruption Force", fx: "Disruption" },
        { name: "Teleport Damage", effect: "Teleportation deals DMG (MAX HP as ATK, MAX HP as 6000% ATK)", chain: "child", chainFrom: "Random Disturbance" },
        { name: "Converging Field", effect: "Drone DMG +100%, attracts enemies toward center", unlock: "Lv18" },
        { name: "Fortress Support", effect: "Launch additional Disruption Drones above Fortress" },
        { name: "Field Replication", effect: "When Railgun Shell hits Field first time, splits into 1 additional Railgun Shell" },
      ]},
    },
    chains: [
      { name: "Disruption Force Path", nodes: [
        { name: "Disruption Force", tier: 1 }, { name: "Disruption Burst", tier: 2 }, { name: "Overcharged Field", tier: 2, note: "Lv22" }, { name: "Area Disruption", tier: 3 }
      ]},
      { name: "Random Disturbance Path", nodes: [
        { name: "Random Disturbance", tier: 1 }, { name: "Rewind Teleport", tier: 2 }, { name: "Teleport Damage", tier: 3 }
      ]},
    ]
  },
  {
    name: "Firewheel Drone", icon: "üî•", type: "Summon / DoT", accent: "#f97316",
    tiers: {
      1: { cards: [
        { name: "Firewheel Boost", effect: "Drone DMG +50%" },
        { name: "Size Boost", effect: "Drone size +25%" },
        { name: "Duration Extension", effect: "Drone duration +30%" },
        { name: "Mini Drones", effect: "Summons 2 Mini Firewheel Drones every 3s", chain: "root", chainTo: ["Killing Array (T2)", "Mini Size Boost (T3)"] },
        { name: "Flame Trail", effect: "Leaves a Flame Trail for 2s during flight", chain: "root", chainTo: ["Blazing Trail (T2)", "Extended Trail (T3 Lv14)"] },
        { name: "Smart Acceleration", effect: "DMG +60%, speed +80%, targets enemies" },
        { name: "Hold the Ground", effect: "Drone stays for additional 10s after ending" },
      ]},
      2: { cards: [
        { name: "Killing Array", effect: "Per 2 enemies killed, summons 2 Mini Firewheel Drones", chain: "child", chainFrom: "Mini Drones" },
        { name: "Blazing Trail", effect: "Flame Trail DMG +60%", chain: "child", chainFrom: "Flame Trail" },
        { name: "Killing Charge", effect: "Per 2 enemies killed, CD -0.5s (MAX 5s)" },
        { name: "Combo Boost", effect: "Per 20 hits, DMG +20% (MAX 200%)" },
        { name: "Firewheel Ignition", effect: "20% chance to inflict [Burn]", fx: "Burn" },
        { name: "Vortex Firewheel", effect: "Creates a pull effect around it", unlock: "Lv18" },
      ]},
      3: { cards: [
        { name: "Mini Size Boost", effect: "Mini Drone DMG +50%, duration +50%", chain: "child", chainFrom: "Mini Drones" },
        { name: "Extended Trail", effect: "Firewheel duration +2s", chain: "child", chainFrom: "Flame Trail", unlock: "Lv14" },
        { name: "Extra Barrage", effect: "Per 15 hits, launch 1 ring of penetrating bullets" },
        { name: "Blazing Pulse", effect: "Releases pulse wave every 5s", unlock: "Lv22" },
      ]},
    },
    chains: [
      { name: "Mini Drones Path", nodes: [
        { name: "Mini Drones", tier: 1 }, { name: "Killing Array", tier: 2 }, { name: "Mini Size Boost", tier: 3 }
      ]},
      { name: "Flame Trail Path", nodes: [
        { name: "Flame Trail", tier: 1 }, { name: "Blazing Trail", tier: 2 }, { name: "Extended Trail", tier: 3, note: "Lv14" }
      ]},
    ]
  },
  {
    name: "Gravity Vortex Gun", icon: "üåë", type: "Control / AoE", accent: "#8b5cf6",
    tiers: {
      1: { cards: [
        { name: "High Power Field", effect: "Field DMG +50%" },
        { name: "Wide Field", effect: "Field range +25%" },
        { name: "Extended Field", effect: "Flight distance +30%" },
        { name: "Static Wormhole", effect: "When Field ends, creates a portal entrance for 3s", chain: "root", chainTo: ["Wormhole Expansion (T2)", "Wormhole Enhancement (T2)"] },
        { name: "Small Black Hole", effect: "Creates a Black Hole pulling enemies after Field disappears", chain: "root", chainTo: ["Black Hole Expansion (T2)", "Destructive Black Hole (T3 Lv14)"] },
        { name: "Extended Pull", effect: "The further it flies, the larger the range" },
        { name: "Field Amplification", effect: "DMG +80%, pulling force +100%" },
      ]},
      2: { cards: [
        { name: "Wormhole Enhancement", effect: "Portal duration +100%", chain: "child", chainFrom: "Static Wormhole" },
        { name: "Wormhole Expansion", effect: "Portal entry range +100%", chain: "child", chainFrom: "Static Wormhole" },
        { name: "Black Hole Expansion", effect: "Range +50%, pulling force +50%", chain: "child", chainFrom: "Small Black Hole" },
        { name: "Extra Field", effect: "Gravitational Field +1" },
        { name: "Extended Range", effect: "Flight distance doubled" },
        { name: "Field Reflection", effect: "All Fields can reflect" },
        { name: "Field Disruption", effect: "Inflicts [Disruption] on hit", fx: "Disruption" },
      ]},
      3: { cards: [
        { name: "Destructive Black Hole", effect: "Small Black Hole DMG +250%", chain: "child", chainFrom: "Small Black Hole", unlock: "Lv14" },
        { name: "Double Fission", effect: "Field splits into two smaller Fields at end", unlock: "Lv18" },
        { name: "Binary Stars", effect: "Field splits into spinning Binary Stars", unlock: "Lv22" },
      ]},
    },
    chains: [
      { name: "Static Wormhole Path", nodes: [
        { name: "Static Wormhole", tier: 1 }, { name: "Wormhole Expansion", tier: 2 }, { name: "Wormhole Enhancement", tier: 2 }
      ]},
      { name: "Small Black Hole Path", nodes: [
        { name: "Small Black Hole", tier: 1 }, { name: "Black Hole Expansion", tier: 2 }, { name: "Destructive Black Hole", tier: 3, note: "Lv14" }
      ]},
    ]
  },
  {
    name: "Guardian", icon: "üõ°Ô∏è", type: "Bullet / Multi-hit", accent: "#10b981",
    tiers: {
      1: { cards: [
        { name: "Volley Shot", effect: "Bullets +1, DMG -15%" },
        { name: "Bullets Boost", effect: "Bullets DMG +50%" },
        { name: "Piercing Bullet", effect: "Bullet Penetration +1" },
        { name: "Bullet Explosion", effect: "10% chance to explode on hit", chain: "root", chainTo: ["Explosion Expansion (T2)", "Explosion Boost (T3)"] },
        { name: "Charge Activation", effect: "Enters Charged State, gaining Charge Points by firing", chain: "root", chainTo: ["Sustained Charge (T2)", "Quick Charge (T2)"] },
        { name: "Volley Shot +", effect: "Bullets +1" },
        { name: "Rapid Fire", effect: "Fire rate +20%" },
        { name: "Shotgun Evolution", effect: "Each shot scatters 2 additional sub-bullets" },
        { name: "Splitting Bullet", effect: "Bullets split into 1 sub-bullet; 2 in Charged State" },
        { name: "Impact Bullet", effect: "DMG +100%; weak knockback; knockback +200% in Charged State" },
      ]},
      2: { cards: [
        { name: "Explosion Expansion", effect: "Explosion range +50%", chain: "child", chainFrom: "Bullet Explosion" },
        { name: "Quick Charge", effect: "Charge Points from bullets +100%", chain: "child", chainFrom: "Charge Activation" },
        { name: "Sustained Charge", effect: "In Charged State, shots fired +100%", chain: "child", chainFrom: "Charge Activation" },
        { name: "Penetration Boost", effect: "All bullets penetration +2" },
        { name: "Reflection Boost", effect: "All bullets reflection +2" },
        { name: "Flame Bullet", effect: "Bullets become flame bullets, extra fire DMG on hit" },
        { name: "Electric Bullet", effect: "50% chance to trigger small Lightning Strike on kill" },
        { name: "Counterwave Scatter", effect: "After counterwave, shoots 5 penetrating shells near Fortress", unlock: "Lv101" },
      ]},
      3: { cards: [
        { name: "Explosion Boost", effect: "Explosion DMG +50%, chance +10%", chain: "child", chainFrom: "Bullet Explosion" },
        { name: "Laser Shot", effect: "20% chance to trigger Ripping Lasers; doubled in Charged State" },
        { name: "Disruption Fire", effect: "10% chance to inflict 1 stack of [Disruption]", fx: "Disruption" },
        { name: "Mirror Guardian", effect: "Releases a clone dealing 50% DMG", unlock: "Lv121" },
      ]},
    },
    chains: [
      { name: "Bullet Explosion Path", nodes: [
        { name: "Bullet Explosion", tier: 1 }, { name: "Explosion Expansion", tier: 2 }, { name: "Explosion Boost", tier: 3 }
      ]},
      { name: "Charge Activation Path", nodes: [
        { name: "Charge Activation", tier: 1 }, { name: "Sustained Charge", tier: 2 }, { name: "Quick Charge", tier: 2 }
      ]},
    ]
  },
  {
    name: "Laser", icon: "üî¥", type: "Sweep / AoE", accent: "#ec4899",
    tiers: {
      1: { cards: [
        { name: "Laser Amplification", effect: "DMG +50%" },
        { name: "Stable Energy", effect: "Duration +40%" },
        { name: "Laser Reflection", effect: "Reflection +1, DMG -20% per reflection" },
        { name: "Additional Sweep", effect: "Fires 1 additional Sweeping Laser", chain: "root", chainTo: ["Vulnerable Laser (T2)", "Sweep Boost (T3)"] },
        { name: "Energy Surge", effect: "Fires 2 additional Deflected Lasers", chain: "root", chainTo: ["Slow Laser (T2)", "Reflected Laser (T3 Lv14)"] },
        { name: "High-Energy Pulse", effect: "DMG Range +100%" },
        { name: "Multi-Strike", effect: "Duration +100%, cooldown speed +20%" },
      ]},
      2: { cards: [
        { name: "Vulnerable Laser", effect: "Enemies hit by Sweeping Lasers receive [Vulnerable]", chain: "child", chainFrom: "Additional Sweep", fx: "Vulnerable" },
        { name: "Slow Laser", effect: "Enemies hit by Deflected Lasers receive [Slow]", chain: "child", chainFrom: "Energy Surge", fx: "Slow" },
        { name: "Energy Overload", effect: "Default duration from all Lasers +100%" },
        { name: "Tear Explosion", effect: "20% chance to trigger Ripping Lasers on hit" },
        { name: "Energy Boost", effect: "DMG increases per enemy hit (MAX 300%)", unlock: "Lv18" },
        { name: "Energy Paralysis", effect: "Enemies hit receive [Paralyze]", fx: "Paralyze" },
        { name: "Graviton Laser", effect: "Creates a pull effect on nearby enemies", unlock: "Lv22" },
      ]},
      3: { cards: [
        { name: "Sweep Boost", effect: "Sweeping Laser sweeps once again", chain: "child", chainFrom: "Additional Sweep" },
        { name: "Reflected Laser", effect: "Reflections +1", chain: "child", chainFrom: "Energy Surge", unlock: "Lv14" },
        { name: "Energy Detonation", effect: "Lasers hitting enemies with [Burn] trigger Ignition Explosion", fx: "Burn" },
        { name: "Convergence Trigger", effect: "30% chance to generate a Refracted Beam on hit" },
      ]},
    },
    chains: [
      { name: "Additional Sweep Path", nodes: [
        { name: "Additional Sweep", tier: 1 }, { name: "Vulnerable Laser", tier: 2 }, { name: "Sweep Boost", tier: 3 }
      ]},
      { name: "Energy Surge Path", nodes: [
        { name: "Energy Surge", tier: 1 }, { name: "Slow Laser", tier: 2 }, { name: "Reflected Laser", tier: 3, note: "Lv14" }
      ]},
    ]
  },
  {
    name: "Railgun", icon: "üî´", type: "Piercing / Single-target", accent: "#64748b",
    tiers: {
      1: { cards: [
        { name: "Ammo Boost", effect: "Shell DMG +50%" },
        { name: "Shell Salvo", effect: "Shell +1, DMG -15%" },
        { name: "Railgun Upgrade", effect: "Shell DMG +30%, Penetration +1" },
        { name: "Basic Split", effect: "On first hit, splits into 2 shells; 25% chance to split again", chain: "root", chainTo: ["Piercing Enhancement (T2)", "Split Mastery (T3)"] },
        { name: "Explosive Shells", effect: "Shell explodes on hit", chain: "root", chainTo: ["Impact Spread (T2)", "Impact Boost (T2 Lv10)"] },
        { name: "Power Penetration", effect: "Penetration +3, knockback +100%" },
        { name: "Weak Spot Strike", effect: "DMG increases with enemy HP (MAX 150%)" },
      ]},
      2: { cards: [
        { name: "Piercing Enhancement", effect: "On first hit, splits into 2 more shells; 25% chance to split again", chain: "child", chainFrom: "Basic Split" },
        { name: "Impact Spread", effect: "Explosion range +20% per penetration", chain: "child", chainFrom: "Explosive Shells" },
        { name: "Impact Boost", effect: "Explosion DMG +30% per penetration", chain: "child", chainFrom: "Explosive Shells", unlock: "Lv10" },
        { name: "Shell Crit Boost", effect: "All Shells DMG +40%, Crit Rate +30%" },
        { name: "Execution Penetration", effect: "Penetration +1 on kill (MAX +5)" },
        { name: "Piercing Mark", effect: "Enemies hit receive [Physical Vulnerable]", fx: "Physical Vulnerable" },
        { name: "Surge Pierce", effect: "50% chance to trigger high voltage shock on kill", unlock: "Lv22" },
      ]},
      3: { cards: [
        { name: "Split Mastery", effect: "All Shells split chance +40%", chain: "child", chainFrom: "Basic Split" },
        { name: "Secondary Minefield", effect: "Shell releases Floating Mine on hit" },
        { name: "Piercing Ricochet", effect: "All Shells reflection +1, penetration +1", unlock: "Lv18" },
      ]},
    },
    chains: [
      { name: "Basic Split Path", nodes: [
        { name: "Basic Split", tier: 1 }, { name: "Piercing Enhancement", tier: 2 }, { name: "Split Mastery", tier: 3 }
      ]},
      { name: "Explosive Shells Path", nodes: [
        { name: "Explosive Shells", tier: 1 }, { name: "Impact Spread", tier: 2 }, { name: "Impact Boost", tier: 2, note: "Lv10" }
      ]},
    ]
  },
  {
    name: "Skyguard", icon: "üöÄ", type: "Missile / AoE", accent: "#f59e0b",
    tiers: {
      1: { cards: [
        { name: "Volley Missile", effect: "Missile +1, DMG -15%" },
        { name: "Sky Guard Boost", effect: "Missile DMG +50%" },
        { name: "Explosion Spread", effect: "Explosion range +30%" },
        { name: "Impact Reinforcement", effect: "After hit, launches 3 Small Missiles (impact DMG only)", chain: "root", chainTo: ["Missile Amplification (T2)", "Thermal Warhead (T2 Lv22)", "Chain Reaction (T3)"] },
        { name: "Ignition", effect: "Enemies hit receive [Burn]", chain: "root", chainTo: ["Ignition Amplification (T2)", "Death Ignition (T3)"], fx: "Burn" },
        { name: "Burning Area", effect: "Missiles leave burning area for 5s after exploding" },
        { name: "Impact Multiplier", effect: "All Missiles impact DMG +200%" },
      ]},
      2: { cards: [
        { name: "Missile Amplification", effect: "Small Missiles +3", chain: "child", chainFrom: "Impact Reinforcement" },
        { name: "Ignition Amplification", effect: "[Burn] DMG +100%", chain: "child", chainFrom: "Ignition", fx: "Burn" },
        { name: "Thermal Warhead", effect: "60% chance to explode on hit", chain: "child", chainFrom: "Impact Reinforcement", unlock: "Lv22" },
        { name: "Strong Impact", effect: "Missile +2" },
        { name: "Close-range Explosion", effect: "After explosion, additional explosions created", unlock: "Lv14" },
        { name: "Collapse Explosion", effect: "Creates Small Black Hole after Missile explodes" },
      ]},
      3: { cards: [
        { name: "Chain Reaction", effect: "Small Missiles have 60% chance to launch additional Small Missile on hit", chain: "child", chainFrom: "Impact Reinforcement" },
        { name: "Death Ignition", effect: "Triggers explosion when enemy dies under [Burn]", chain: "child", chainFrom: "Ignition", fx: "Burn" },
        { name: "Fire Transmission", effect: "Missiles apply [Burn] to enemies along their path", fx: "Burn" },
        { name: "Detonation Thunderbolt", effect: "Generates secondary small Thunderbolt for 5s after kills" },
        { name: "Path Strike", effect: "Missiles deal DMG to enemies along their path" },
      ]},
    },
    chains: [
      { name: "Impact Reinforcement Path", nodes: [
        { name: "Impact Reinforcement", tier: 1 }, { name: "Missile Amplification", tier: 2 }, { name: "Thermal Warhead", tier: 2, note: "Lv22" }, { name: "Chain Reaction", tier: 3 }
      ]},
      { name: "Ignition Path", nodes: [
        { name: "Ignition", tier: 1 }, { name: "Ignition Amplification", tier: 2 }, { name: "Death Ignition", tier: 3 }
      ]},
    ]
  },
  {
    name: "Teslacoil", icon: "‚öôÔ∏è", type: "Electric / AoE", accent: "#22d3ee",
    tiers: {
      1: { cards: [
        { name: "Electro Boost", effect: "DMG +50%" },
        { name: "Electro Chain", effect: "Bounces +1, DMG -15%" },
        { name: "Electro Acceleration", effect: "Cooldown speed +30%" },
        { name: "Charge Expansion", effect: "Charge time +0.5s, DMG increases with charge time", chain: "root", chainTo: ["Charge Destruction (T2)", "Charge Delayed (T3)"] },
        { name: "Trap Matrix", effect: "Releases Electric Matrix with DMG and [Slow] for 2s", chain: "root", chainTo: ["Enhanced Matrix (T2)", "Matrix Thunderbolt (T3 Lv10)"], fx: "Slow" },
        { name: "Electric Chain Surge", effect: "Releases up to 5 high-voltage shocks on nearby enemies" },
        { name: "Electro Interference", effect: "Explosion and Electric Matrix inflict [Paralyze]", fx: "Paralyze" },
      ]},
      2: { cards: [
        { name: "Charge Destruction", effect: "Charge time +0.5s, DMG increases with charge time", chain: "child", chainFrom: "Charge Expansion" },
        { name: "Enhanced Matrix", effect: "Electric Matrix DMG +100%, duration +1s", chain: "child", chainFrom: "Trap Matrix" },
        { name: "Expanded Shockwave", effect: "Explosion range increased, outer DMG radius" },
        { name: "Charged Shock", effect: "During charging, releases high-voltage shock every 0.25s" },
        { name: "Cooperative Beam", effect: "During charging, releases 2 Refracted Beams" },
        { name: "Wasp Mirage", effect: "On hit, summons an Echo Wasp", unlock: "Lv22" },
      ]},
      3: { cards: [
        { name: "Charge Delayed", effect: "Charge time +1s", chain: "child", chainFrom: "Charge Expansion" },
        { name: "Matrix Thunderbolt", effect: "Spawns a Thunderbolt every 0.5s, lasting 5s", chain: "child", chainFrom: "Trap Matrix", unlock: "Lv10" },
        { name: "Highvolt Trigger", effect: "Explosion triggers 1 Chain Lightning on hit (MAX 15)" },
        { name: "Spinning Laser", effect: "Releases a Spinning Laser on hit", unlock: "Lv14" },
      ]},
    },
    chains: [
      { name: "Charge Expansion Path", nodes: [
        { name: "Charge Expansion", tier: 1 }, { name: "Charge Destruction", tier: 2 }, { name: "Charge Delayed", tier: 3 }
      ]},
      { name: "Trap Matrix Path", nodes: [
        { name: "Trap Matrix", tier: 1 }, { name: "Enhanced Matrix", tier: 2 }, { name: "Matrix Thunderbolt", tier: 3, note: "Lv10" }
      ]},
    ]
  },
  {
    name: "Thunderbolt", icon: "üå©Ô∏è", type: "Electric / Strike", accent: "#eab308",
    tiers: {
      1: { cards: [
        { name: "Continuous Strike", effect: "+1 Thunderbolt, DMG -15%" },
        { name: "Swift Strike", effect: "Cooldown speed +10%, DMG +30%" },
        { name: "Lightning Boost", effect: "DMG +50%" },
        { name: "Lightning Paralysis", effect: "Enemies hit receive [Paralyze]", chain: "root", chainTo: ["Paralysis Extension (T2)", "Paralyzing Shock (T2 Lv22)", "Life Erosion (T3)"], fx: "Paralyze" },
        { name: "Chain Lightning", effect: "Triggers Chain Lightning on hit (MAX 5)", chain: "root", chainTo: ["Chain Expansion (T2)", "Chain Strike (T2 Lv18)", "Chain Interference (T3)"] },
        { name: "Lightning Expansion", effect: "Width +100%" },
        { name: "Slaughtering Lightning", effect: "60% chance to generate another Lightning Strike on kill" },
      ]},
      2: { cards: [
        { name: "Paralysis Extension", effect: "[Paralyze] duration +100%", chain: "child", chainFrom: "Lightning Paralysis", fx: "Paralyze" },
        { name: "Chain Expansion", effect: "Chain Lightning targets +4", chain: "child", chainFrom: "Chain Lightning" },
        { name: "Paralyzing Shock", effect: "Creates lightning shock that paralyzes enemies", chain: "child", chainFrom: "Lightning Paralysis", unlock: "Lv22", fx: "Paralyze" },
        { name: "Extra Strike", effect: "50% chance to trigger 1 more Lightning Strike" },
        { name: "Thunder Chain", effect: "Enemies hit by Chain Lightning can't move (2s, 0.5s interval)" },
        { name: "Chain Strike", effect: "Enemies hit by Chain Lightning have 25% chance to trigger Lightning Strike", chain: "child", chainFrom: "Chain Lightning", unlock: "Lv18" },
        { name: "Lightning Trail", effect: "After strike, leaves a flame trail during flight" },
      ]},
      3: { cards: [
        { name: "Life Erosion", effect: "Additional DMG based on MAX HP + [Paralyze] (MAX 6000% ATK)", chain: "child", chainFrom: "Lightning Paralysis", fx: "Paralyze" },
        { name: "Chain Interference", effect: "Chain Lightning inflicts [Paralyze], DMG +100%", chain: "child", chainFrom: "Chain Lightning", fx: "Paralyze" },
        { name: "Lightning Teleportation", effect: "50% chance to teleport enemies back on hit" },
      ]},
    },
    chains: [
      { name: "Lightning Paralysis Path", nodes: [
        { name: "Lightning Paralysis", tier: 1 }, { name: "Paralysis Extension", tier: 2 }, { name: "Paralyzing Shock", tier: 2, note: "Lv22" }, { name: "Life Erosion", tier: 3 }
      ]},
      { name: "Chain Lightning Path", nodes: [
        { name: "Chain Lightning", tier: 1 }, { name: "Chain Expansion", tier: 2 }, { name: "Chain Strike", tier: 2, note: "Lv18" }, { name: "Chain Interference", tier: 3 }
      ]},
    ]
  },
  {
    name: "Wasp (Hive)", icon: "üêù", type: "Summon / Swarm", accent: "#84cc16",
    tiers: {
      1: { cards: [
        { name: "Swarm Assault", effect: "DMG +50%" },
        { name: "Rapid Barrage", effect: "Attack count +2" },
        { name: "Dense Swarm", effect: "Wasps +2, DMG -15%" },
        { name: "Contact Pulse", effect: "Releases 1 Pulse Wave on first hit", chain: "root", chainTo: ["Amplified Pulse (T2)", "Final Resonance (T2)"] },
        { name: "Swarm Echo", effect: "Spawn 1 Echo Wasp on kill (MAX 1)", chain: "root", chainTo: ["Echo Upgrade II (T2)", "Echo Upgrade III (T3)"] },
        { name: "Wasp Evolution II", effect: "Wasp evolves to II after 3 attacks" },
        { name: "Hive Mutation II", effect: "Hive launches Wasp II after 2 volleys" },
      ]},
      2: { cards: [
        { name: "Amplified Pulse", effect: "Pulse Wave DMG range +30%, inflicts [Slow]", chain: "child", chainFrom: "Contact Pulse", fx: "Slow" },
        { name: "Final Resonance", effect: "Wasp releases 1 Pulse Wave when it ends", chain: "child", chainFrom: "Contact Pulse" },
        { name: "Echo Upgrade II", effect: "Evolves echoes to Echo Wasp II", chain: "child", chainFrom: "Swarm Echo" },
        { name: "Wasp Evolution III", effect: "Wasp II evolves to III after 3 attacks" },
        { name: "Hive Mutation III", effect: "50% chance to launch Wasp III after 2 volleys" },
        { name: "Wasp Retrieval", effect: "50% chance to return to Hive when destroyed (MAX 5 stored)", unlock: "Lv14" },
        { name: "Electro-Wasps", effect: "50% chance per attack to release high-voltage shock" },
        { name: "Aero Split", effect: "60% chance to split into 3 Small Railgun Shells on hit", unlock: "Lv22" },
      ]},
      3: { cards: [
        { name: "Echo Upgrade III", effect: "Evolves echoes to Echo Wasp III", chain: "child", chainFrom: "Swarm Echo" },
        { name: "Volley Wasp", effect: "Bullets +1" },
        { name: "Swarm Fury", effect: "+30% DMG after each attack" },
      ]},
    },
    chains: [
      { name: "Contact Pulse Path", nodes: [
        { name: "Contact Pulse", tier: 1 }, { name: "Amplified Pulse", tier: 2 }, { name: "Final Resonance", tier: 2 }
      ]},
      { name: "Swarm Echo Path", nodes: [
        { name: "Swarm Echo", tier: 1 }, { name: "Echo Upgrade II", tier: 2 }, { name: "Echo Upgrade III", tier: 3 }
      ]},
    ]
  },
];



// ============================================================
// TURRET INDEX LOOKUP
// ============================================================
const TURRET_IDX = {};
TURRETS.forEach((t, i) => { TURRET_IDX[t.name] = i; });

// ============================================================
// CARD TYPE RESOLVER & STATE
// ============================================================
function getCardTypes(card) {
  const types = [];
  if (card.chain === 'root' || card.chain === 'child') types.push('chain');
  if (COMBOS[card.name]) types.push('combo');
  if (card.unlock) types.push('breakthrough');
  if (types.length === 0) types.push('normal');
  return types;
}

// ============================================================
// STATE
// ============================================================
let activeTurret = null;
let searchQuery = '';
let activeFilters = { type: null, effect: null, tier: null };

// ============================================================
// CHAIN MAP
// ============================================================
let currentChainMap = {};
let currentCardIdMap = {};
let currentCardEffectMap = {};

function buildChainMap(t) {
  currentChainMap = {};
  currentCardIdMap = {};
  currentCardEffectMap = {};
  for (const tierNum of Object.keys(t.tiers)) {
    t.tiers[tierNum].cards.forEach((c, idx) => {
      currentCardIdMap[c.name] = 'card-' + tierNum + '-' + idx;
      currentCardEffectMap[c.name] = c.effect || '';
    });
  }
  for (const chain of t.chains) {
    for (const node of chain.nodes) {
      currentChainMap[node.name] = {
        tier: node.tier, note: node.note || null,
        chainName: chain.name, chainNodes: chain.nodes
      };
    }
  }
}

// ============================================================
// FILTER LOGIC
// ============================================================
function cardMatchesFilters(card, tierNum) {
  const types = getCardTypes(card);
  if (activeFilters.type && !types.includes(activeFilters.type)) return false;
  if (activeFilters.effect) {
    const eff = activeFilters.effect;
    const hasFx = card.fx === eff || card.effect.toLowerCase().includes(eff.toLowerCase());
    if (!hasFx) return false;
  }
  if (activeFilters.tier && String(tierNum) !== activeFilters.tier) return false;
  return true;
}

function turretHasMatchingCards(turret) {
  const q = searchQuery.toLowerCase();
  for (const tierNum of Object.keys(turret.tiers)) {
    for (const card of turret.tiers[tierNum].cards) {
      const matchSearch = !q || turret.name.toLowerCase().includes(q) ||
        card.name.toLowerCase().includes(q) || card.effect.toLowerCase().includes(q) ||
        turret.type.toLowerCase().includes(q);
      const matchFilter = cardMatchesFilters(card, tierNum);
      if (matchSearch && matchFilter) return true;
    }
  }
  return false;
}

function hasAnyFilter() {
  return activeFilters.type || activeFilters.effect || activeFilters.tier;
}

// ============================================================
// STATS
// ============================================================
function updateStats() {
  let total = 0, shown = 0, comboCount = 0, chainCount = 0, btCount = 0;
  TURRETS.forEach(t => {
    Object.keys(t.tiers).forEach(tn => {
      t.tiers[tn].cards.forEach(c => {
        total++;
        const types = getCardTypes(c);
        if (types.includes('combo')) comboCount++;
        if (types.includes('chain')) chainCount++;
        if (types.includes('breakthrough')) btCount++;
        const matchSearch = !searchQuery || t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          c.name.toLowerCase().includes(searchQuery.toLowerCase()) || c.effect.toLowerCase().includes(searchQuery.toLowerCase());
        if (matchSearch && cardMatchesFilters(c, tn)) shown++;
      });
    });
  });
  document.getElementById('statsBar').innerHTML =
    '<div class="stat-chip"><strong>' + shown + '</strong> / ' + total + ' cards shown</div>' +
    '<div class="stat-chip" style="color:#22d3ee"><strong>' + chainCount + '</strong> chain</div>' +
    '<div class="stat-chip" style="color:#10b981"><strong>' + comboCount + '</strong> combo</div>' +
    '<div class="stat-chip" style="color:#fbbf24"><strong>' + btCount + '</strong> breakthrough</div>';
}

// ============================================================
// RENDER
// ============================================================
function renderGrid() {
  const grid = document.getElementById('turretGrid');
  grid.innerHTML = TURRETS.map((t, i) => {
    const totalCards = Object.values(t.tiers).reduce((s, tier) => s + tier.cards.length, 0);
    const visibleCards = hasAnyFilter()
      ? Object.entries(t.tiers).reduce((s, [n, tier]) => s + tier.cards.filter(c => cardMatchesFilters(c, n)).length, 0)
      : totalCards;
    const countLabel = hasAnyFilter() ? visibleCards + '/' + totalCards + ' cards' : totalCards + ' cards';
    const hidden = !turretHasMatchingCards(t) ? ' hidden' : '';
    const active = activeTurret === i ? ' active' : '';
    return '<div class="turret-tile' + hidden + active + '" style="--tile-accent:' + t.accent + '" onclick="selectTurret(' + i + ')" id="turret-tile-' + i + '">' +
      '<div class="tile-icon" style="background:' + t.accent + '18">' + t.icon + '</div>' +
      '<div class="tile-name">' + t.name + '</div>' +
      '<div class="tile-type">' + t.type + '</div>' +
      '<div class="tile-card-count">' + countLabel + '</div></div>';
  }).join('');
  updateStats();
}

function selectTurret(idx) {
  if (activeTurret === idx) { closeTurret(); return; }
  activeTurret = idx;
  renderGrid();
  renderDetail(TURRETS[idx]);
  document.getElementById('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeTurret() {
  activeTurret = null;
  document.getElementById('detailPanel').classList.remove('open');
  renderGrid();
}

function renderDetail(t) {
  buildChainMap(t);
  const panel = document.getElementById('detailPanel');
  const tierNums = Object.keys(t.tiers);
  const totalCards = Object.values(t.tiers).reduce((s, tier) => s + tier.cards.length, 0);

  // Pre-calculate which tiers have at least one visible card
  const tierHasVisible = {};
  tierNums.forEach(n => {
    tierHasVisible[n] = t.tiers[n].cards.some(c => !hasAnyFilter() || cardMatchesFilters(c, n));
  });

  // Find the first tier tab that has visible cards (fall back to '1')
  const firstVisibleTier = tierNums.find(n => tierHasVisible[n]) || '1';

  let html = '<div class="detail-header"><div class="detail-header-left">' +
    '<div class="detail-icon" style="background:' + t.accent + '18;font-size:28px">' + t.icon + '</div>' +
    '<div><div class="detail-title" style="color:' + t.accent + '">' + t.name + '</div>' +
    '<div class="detail-subtitle">' + t.type + ' &middot; ' + totalCards + ' cards total</div></div></div>' +
    '<button class="close-btn" onclick="closeTurret()">&times;</button></div><div class="tab-bar">';

  tierNums.forEach(n => {
    const visibleCount = t.tiers[n].cards.filter(c => !hasAnyFilter() || cardMatchesFilters(c, n)).length;
    const totalCount = t.tiers[n].cards.length;
    const isActive = n === firstVisibleTier;
    const hiddenTab = !tierHasVisible[n] ? ' style="display:none"' : '';
    const countLabel = hasAnyFilter() ? visibleCount + '/' + totalCount : totalCount;
    html += '<button class="tab-btn' + (isActive ? ' active' : '') + '" data-tier="' + n + '" onclick="switchTab(this,\'tier' + n + '\')"' + hiddenTab + '>' +
      'Tier ' + n + ' <span class="tab-count">' + countLabel + '</span></button>';
  });
  html += '<button class="tab-btn" data-tier="chains" onclick="switchTab(this,\'chains\')">Chains <span class="tab-count">' + t.chains.length + '</span></button></div>';

  tierNums.forEach(n => {
    const isActive = n === firstVisibleTier;
    html += '<div class="tab-content' + (isActive ? ' active' : '') + '" id="tab-tier' + n + '"><div class="card-list">' +
      t.tiers[n].cards.map((c, idx) => renderCardRow(c, n, idx, t.name)).join('') + '</div></div>';
  });

  html += '<div class="tab-content" id="tab-chains"><div class="chain-tree-section">' +
    t.chains.map(ch => renderChainTree(ch)).join('') + '</div></div>';

  panel.innerHTML = html;
  panel.classList.add('open');
}

function renderCardRow(card, tierNum, cardIdx, turretName) {
  const isRoot = card.chain === 'root';
  const isChild = card.chain === 'child';
  const isChain = isRoot || isChild;
  const isCombo = !!COMBOS[card.name];
  const types = getCardTypes(card);
  const hidden = hasAnyFilter() && !cardMatchesFilters(card, tierNum) ? ' filter-hidden' : '';

  let cls = 'card-row';
  if (isRoot) cls += ' chain-root';
  else if (isChild) cls += ' chain-child';
  else if (isCombo) cls += ' combo-card';
  cls += hidden;

  const domId = 'card-' + tierNum + '-' + cardIdx;
  let effectHtml = highlightEffects(card.effect);

  // Type badges
  let typeBadges = types.map(t => {
    const labels = { normal: 'Normal', chain: isRoot ? 'Chain Root' : 'Chain', combo: 'Combo', breakthrough: 'Breakthrough' };
    return '<span class="card-type-badge ctb-' + t + '">' + (labels[t] || t) + '</span>';
  }).join(' ');

  // Meta tags
  let meta = '';
  if (card.unlock) meta += '<span class="meta-tag tag-unlock">' + card.unlock + '</span>';

  let chainIcon = '';
  if (isRoot) chainIcon = '<span class="chain-icon">‚õì</span>';
  if (isChild) chainIcon = '<span class="chain-icon" style="background:rgba(34,211,238,0.06)">‚Ü≥</span>';

  // Chain path strip
  const chainStrip = isChain ? renderChainPathStrip(card.name) : '';

  // Combo strip
  let comboStrip = '';
  if (isCombo) {
    const pair = COMBOS[card.name];
    const otherTurret = pair[0] === turretName ? pair[1] : pair[0];
    const otherIdx = TURRET_IDX[otherTurret];
    const otherData = otherIdx !== undefined ? TURRETS[otherIdx] : null;
    const otherIcon = otherData ? otherData.icon : '';
    comboStrip = '<div class="combo-strip"><span class="combo-strip-label">Ô§ù Combo</span>' +
      '<span class="combo-turret-link" onclick="event.stopPropagation();selectTurret(' + TURRET_IDX[turretName] + ')"><span class="combo-icon">' + TURRETS[TURRET_IDX[turretName]].icon + '</span>' + turretName + '</span>' +
      '<span class="combo-plus">+</span>' +
      (otherIdx !== undefined ?
        '<span class="combo-turret-link" onclick="event.stopPropagation();selectTurret(' + otherIdx + ')"><span class="combo-icon">' + otherIcon + '</span>' + otherTurret + '</span>' :
        '<span class="combo-turret-link">' + otherTurret + '</span>') +
      '</div>';
  }

  return '<div class="' + cls + '" id="' + domId + '">' +
    '<div class="card-name-cell">' + chainIcon + '<span class="card-name">' + card.name + '</span> ' + typeBadges + '</div>' +
    '<div class="card-effect">' + effectHtml + '</div>' +
    '<div class="card-meta">' + meta + '</div>' +
    chainStrip + comboStrip + '</div>';
}

function renderChainPathStrip(cardName) {
  const info = currentChainMap[cardName];
  if (!info) return '';
  const nodes = info.chainNodes;
  let html = '<div class="chain-path-strip"><span class="cp-label">‚õì Chain Path</span>';
  nodes.forEach((node, i) => {
    if (i > 0) html += '<span class="chain-path-arrow">‚Üí</span>';
    const isCurrent = node.name === cardName;
    const domId = currentCardIdMap[node.name];
    const tierCls = 'cp-t' + node.tier;
    const noteStr = node.note ? ' (' + node.note + ')' : '';
    if (isCurrent) {
      html += '<span class="chain-path-node ' + tierCls + ' cp-current"><strong>' + node.name + '</strong><small>T' + node.tier + noteStr + '</small></span>';
    } else {
      html += '<span class="chain-path-node ' + tierCls + '" onclick="navigateToCard(\'' + domId + '\',' + node.tier + ')">' + node.name + '<small>T' + node.tier + noteStr + '</small></span>';
    }
  });
  html += '</div>';
  return html;
}

function renderChainTree(chain) {
  const tierLabel = { 1: 'Tier 1', 2: 'Tier 2', 3: 'Tier 3' };
  let nodesHtml = chain.nodes.map((node, i) => {
    const arrow = i > 0 ? '<span class="node-arrow">‚Üí</span>' : '';
    const domId = currentCardIdMap[node.name] || '';
    const rawEffect = currentCardEffectMap[node.name] || '';
    const effectHtml = rawEffect ? '<div class="node-effect">' + highlightEffects(rawEffect) + '</div>' : '';
    return arrow + '<div class="chain-node node-t' + node.tier + '" onclick="navigateToCard(\'' + domId + '\',' + node.tier + ')">' +
      '<div class="node-dot"><div class="node-dot-inner"></div></div>' +
      '<div class="node-info"><div class="node-name">' + node.name + '</div>' +
      '<span class="node-tier">' + tierLabel[node.tier] + (node.note ? ' ¬∑ ' + node.note : '') + '</span>' +
      effectHtml + '</div></div>';
  }).join('');
  return '<div class="chain-tree"><div class="chain-tree-title">' + chain.name + '</div><div class="chain-nodes">' + nodesHtml + '</div></div>';
}

// ============================================================
// UTILITIES
// ============================================================
// === EFFECT DESCRIPTIONS ===
const EFFECT_DESCS = {
  'Paralyze':           { cls: 'fx-paralyze',  desc: 'Unable to move or attack for 1.5 seconds.' },
  'Disruption':         { cls: 'fx-disruption', desc: 'Reduces enemy DMG by 10% per stack, up to 3 stacks, for 5 seconds.' },
  'Burn':               { cls: 'fx-burn',       desc: 'Deals burn damage over time for 5 seconds.' },
  'Vulnerable':         { cls: 'fx-vulnerable', desc: 'Damage taken increases by 25% for 5 seconds.' },
  'Slow':               { cls: 'fx-slow',       desc: 'Movement speed reduced by 50% for 5 seconds.' },
  'Physical Vulnerable':{ cls: 'fx-physvuln',   desc: 'Physical resistance reduced by 25% for 5 seconds.' },
};

function pill(name) {
  const e = EFFECT_DESCS[name];
  return '<span class="fx-pill ' + e.cls + '" onclick="showEffectTooltip(this,\'' + name.replace(/'/g, "\\'") + '\')" data-effect="' + name + '">' + name + '</span>';
}

function highlightEffects(text) {
  let r = text;
  r = r.replace(/\[Physical Vulnerable\]/g, pill('Physical Vulnerable'));
  r = r.replace(/\[Paralyze\]/g,            pill('Paralyze'));
  r = r.replace(/\[Disruption\]/g,          pill('Disruption'));
  r = r.replace(/\[Burn\]/g,                pill('Burn'));
  r = r.replace(/\[Vulnerable\]/g,          pill('Vulnerable'));
  r = r.replace(/\[Slow\]/g,                pill('Slow'));
  return r;
}

// === TOOLTIP LOGIC ===
let activeTooltipPill = null;

function showEffectTooltip(el, effectName) {
  // If clicking the same pill, close it
  if (activeTooltipPill === el) {
    hideEffectTooltip();
    return;
  }
  activeTooltipPill = el;

  const tooltip = document.getElementById('effectTooltip');
  const nameEl  = document.getElementById('tooltipName');
  const descEl  = document.getElementById('tooltipDesc');
  const info = EFFECT_DESCS[effectName];
  if (!info) return;

  nameEl.textContent = effectName;
  nameEl.className = 'tooltip-name ' + info.cls;
  descEl.textContent = info.desc;

  // Position: above the pill, centred
  tooltip.classList.remove('visible');
  tooltip.style.top = '-9999px';
  tooltip.style.left = '-9999px';
  tooltip.classList.add('visible');

  const pillRect = el.getBoundingClientRect();
  const tipRect  = tooltip.getBoundingClientRect();
  const margin   = 8;

  let top  = pillRect.top - tipRect.height - margin;
  let left = pillRect.left + pillRect.width / 2 - tipRect.width / 2;

  // Flip below if not enough room above
  if (top < 8) {
    top = pillRect.bottom + margin;
    tooltip.querySelector('.tooltip-arrow').style.display = 'none';
  } else {
    tooltip.querySelector('.tooltip-arrow').style.display = 'block';
  }

  // Keep within viewport horizontally
  left = Math.max(8, Math.min(left, window.innerWidth - tipRect.width - 8));

  tooltip.style.top  = top + 'px';
  tooltip.style.left = left + 'px';
}

function hideEffectTooltip() {
  document.getElementById('effectTooltip').classList.remove('visible');
  activeTooltipPill = null;
}

// Close tooltip on outside click or scroll
document.addEventListener('click', (e) => {
  if (!e.target.classList.contains('fx-pill')) hideEffectTooltip();
});
document.addEventListener('scroll', hideEffectTooltip, true);

function navigateToCard(domId, tier) {
  const panel = document.getElementById('detailPanel');
  const tabBtn = panel.querySelector('.tab-btn[data-tier="' + tier + '"]');
  if (tabBtn) switchTab(tabBtn, 'tier' + tier);
  setTimeout(() => {
    const el = document.getElementById(domId);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.classList.remove('highlight-flash');
      void el.offsetWidth;
      el.classList.add('highlight-flash');
    }
  }, 50);
}

function switchTab(btn, tabId) {
  const panel = document.getElementById('detailPanel');
  panel.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  panel.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tabId).classList.add('active');
}

function toggleFilter(el) {
  const filterType = el.dataset.filter;
  const value = el.dataset.value;
  if (activeFilters[filterType] === value) {
    activeFilters[filterType] = null;
    el.classList.remove('active');
  } else {
    document.querySelectorAll('.filter-badge[data-filter="' + filterType + '"]').forEach(b => b.classList.remove('active'));
    activeFilters[filterType] = value;
    el.classList.add('active');
  }
  document.getElementById('clearFilters').classList.toggle('has-filters', hasAnyFilter());
  if (activeTurret !== null) renderDetail(TURRETS[activeTurret]);
  renderGrid();
}

function clearAllFilters() {
  activeFilters = { type: null, effect: null, tier: null };
  document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
  document.getElementById('clearFilters').classList.remove('has-filters');
  if (activeTurret !== null) renderDetail(TURRETS[activeTurret]);
  renderGrid();
}

document.getElementById('searchInput').addEventListener('input', (e) => {
  searchQuery = e.target.value;
  if (activeTurret !== null) { closeTurret(); }
  renderGrid();
});

// === INIT: render everything on page load ===
renderGrid();
</script>
</body>
</html>